name: Recommendation Cooldown
# Applies an exponentially growing cooldown period
# to users whose previous recommendations violated repository rules.
# The cooldown schedule grows with each successive closure, encouraging
# authors to review the guidelines and submit their strongest work.

on:
  issues:
    types: [opened, reopened]

jobs:
  review-recommendation:
    runs-on: ubuntu-latest
    if: ${{ !contains(github.event.issue.labels.*.name, 'resource-submission') }}

    steps:
      - name: Review recommendation eligibility
        uses: actions/github-script@v7
        with:
          script: |
            const author = context.payload.issue.user.login;
            const issueNumber = context.payload.issue.number;
            const repo = context.repo;

            // ---------------------------------------------------------
            // Maintainer override: if the "excused" label is present,
            // skip all checks. This lets the maintainer wave through
            // a recommendation that would otherwise be caught by the
            // cooldown, repo age, or one-at-a-time rules.
            // ---------------------------------------------------------
            const labels = context.payload.issue.labels.map(l => l.name);
            if (labels.includes('excused')) {
              console.log(`#${issueNumber} has "excused" label. Skipping all checks.`);
              return;
            }

            // ---------------------------------------------------------
            // 0. One recommendation at a time
            //    Users may only have one resource recommendation issue
            //    open at a time.
            // ---------------------------------------------------------
            const openIssues = await github.rest.issues.listForRepo({
              ...repo,
              state: 'open',
              creator: author,
              labels: 'resource-submission',
              per_page: 100
            });

            const otherOpen = openIssues.data.filter(i => i.number !== issueNumber);

            if (otherOpen.length > 0) {
              const existingNumbers = otherOpen.map(i => `#${i.number}`).join(', ');

              await github.rest.issues.createComment({
                ...repo,
                issue_number: issueNumber,
                body: `Thanks for the recommendation, but you already have an open recommendation (${existingNumbers}). Per our [guidelines](https://github.com/${repo.owner}/${repo.repo}/issues/674), please submit one recommendation at a time. This issue has been closed — you're welcome to submit again once your current recommendation has been resolved.`
              });

              await github.rest.issues.update({
                ...repo,
                issue_number: issueNumber,
                state: 'closed',
                state_reason: 'not_planned'
              });

              console.log(`Closed #${issueNumber}: ${author} already has open recommendation(s): ${existingNumbers}`);
              return;
            }

            // ---------------------------------------------------------
            // 1. Minimum project maturity (7 days)
            //    Projects should have some time in the wild before
            //    being recommended. This gives authors time to gather
            //    feedback and gives the community time to try it out.
            // ---------------------------------------------------------
            const issueBody = context.payload.issue.body || '';
            const repoUrlMatch = issueBody.match(
              /https?:\/\/github\.com\/([^\/\s]+)\/([^\/\s#?"]+)/
            );

            if (repoUrlMatch) {
              const [, repoOwner, repoName] = repoUrlMatch;
              const cleanName = repoName.replace(/\.git$/, '');

              try {
                const repoData = await github.rest.repos.get({
                  owner: repoOwner,
                  repo: cleanName
                });

                const created = new Date(repoData.data.created_at);
                const now = new Date();
                const ageDays = (now - created) / (1000 * 60 * 60 * 24);

                if (ageDays < 7) {
                  const readyDate = new Date(created);
                  readyDate.setDate(readyDate.getDate() + 7);
                  const readyStr = readyDate.toLocaleDateString('en-US', {
                    month: 'long', day: 'numeric', year: 'numeric'
                  });

                  await github.rest.issues.createComment({
                    ...repo,
                    issue_number: issueNumber,
                    body: `Thanks for the recommendation! This repository is less than a week old. To make sure recommended projects have had some time in the wild, we ask that repos be at least 7 days old before being recommended. You're welcome to re-submit after **${readyStr}**.`
                  });

                  await github.rest.issues.update({
                    ...repo,
                    issue_number: issueNumber,
                    state: 'closed',
                    state_reason: 'not_planned'
                  });

                  console.log(`Closed #${issueNumber}: repo ${repoOwner}/${cleanName} is ${ageDays.toFixed(1)} days old`);
                  return;
                }
              } catch (e) {
                // Repo not found or API error — let it through,
                // the existing validation bot will catch bad URLs
                console.log(`Could not check repo age: ${e.message}`);
              }
            }

            // ---------------------------------------------------------
            // 2. Recommendation history
            //    Look at the author's previous recommendations that
            //    were closed without being accepted. This history is
            //    cumulative — it reflects the author's overall track
            //    record with the list and does not reset.
            // ---------------------------------------------------------
            const closedIssues = await github.rest.issues.listForRepo({
              ...repo,
              state: 'closed',
              creator: author,
              labels: 'resource-submission',
              per_page: 100,
              sort: 'created',
              direction: 'desc'
            });

            const priorClosures = closedIssues.data.filter(issue =>
              issue.state_reason === 'not_planned' &&
              issue.closed_by?.login !== author
            );

            const closureCount = priorClosures.length;

            if (closureCount === 0) {
              console.log(`${author}: first-time or previously accepted recommender. No cooldown.`);
              return;
            }

            // ---------------------------------------------------------
            // 3. Graduated cooldown schedule
            //    The cooldown period grows with each successive closure,
            //    giving authors time to review the guidelines and submit
            //    a stronger recommendation next time.
            //
            //    Closures    Cooldown
            //    1            3 days
            //    2            7 days
            //    3           14 days
            //    4           30 days
            //    5+          60 days (maximum)
            // ---------------------------------------------------------
            const schedule = [3, 7, 14, 30, 60];
            const cooldownDays = schedule[Math.min(closureCount - 1, schedule.length - 1)];

            const lastClosure = new Date(priorClosures[0].closed_at);
            const now = new Date();
            const elapsed = (now - lastClosure) / (1000 * 60 * 60 * 24);

            console.log(`${author}: ${closureCount} prior closure(s), cooldown=${cooldownDays}d, elapsed=${elapsed.toFixed(1)}d`);

            // ---------------------------------------------------------
            // 4. If the cooldown has passed, the recommendation is
            //    eligible for review. Apply a history label so the
            //    maintainer has context at a glance (yellow → red).
            // ---------------------------------------------------------
            if (elapsed >= cooldownDays) {
              const tiers = {
                1: { name: 'history-1', color: 'FEF3C7', description: '1 prior closed recommendation' },
                2: { name: 'history-2', color: 'FED7AA', description: '2 prior closed recommendations' },
                3: { name: 'history-3', color: 'FB923C', description: '3 prior closed recommendations' },
                4: { name: 'history-4', color: 'EA580C', description: '4 prior closed recommendations' },
                5: { name: 'history-5', color: 'DC2626', description: '5+ prior closed recommendations' }
              };

              const tier = Math.min(closureCount, 5);
              const label = tiers[tier];

              try {
                await github.rest.issues.getLabel({ ...repo, name: label.name });
              } catch {
                await github.rest.issues.createLabel({
                  ...repo,
                  name: label.name,
                  color: label.color,
                  description: label.description
                });
              }

              await github.rest.issues.addLabels({
                ...repo,
                issue_number: issueNumber,
                labels: [label.name]
              });

              console.log(`${author}: past cooldown. Applied ${label.name}. Recommendation is eligible for review.`);
              return;
            }

            // ---------------------------------------------------------
            // 5. Cooldown is still active — close with explanation
            // ---------------------------------------------------------
            const reopenDate = new Date(lastClosure);
            reopenDate.setDate(reopenDate.getDate() + cooldownDays);
            const reopenStr = reopenDate.toLocaleDateString('en-US', {
              month: 'long', day: 'numeric', year: 'numeric'
            });

            const daysRemaining = Math.ceil(cooldownDays - elapsed);

            let msg = `Thanks for the recommendation. `;
            msg += `A cooldown period is currently in effect for your account `;
            msg += `(${daysRemaining} day${daysRemaining !== 1 ? 's' : ''} remaining). `;
            msg += `You can submit again after **${reopenStr}**.\n\n`;
            msg += `Please take a moment to review the [CONTRIBUTING guidelines](../blob/main/CONTRIBUTING.md) `;
            msg += `and [pinned issues](https://github.com/${repo.owner}/${repo.repo}/issues) `;
            msg += `before your next recommendation.`;

            await github.rest.issues.createComment({
              ...repo,
              issue_number: issueNumber,
              body: msg
            });

            await github.rest.issues.update({
              ...repo,
              issue_number: issueNumber,
              state: 'closed',
              state_reason: 'not_planned'
            });

            console.log(`Closed #${issueNumber}: ${author} is in cooldown until ${reopenStr}`);
